<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Horizon DMC</title>
    <link rel="stylesheet" href="../agent/css/portal.css">
    <style>
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-Pending {
            background: #fff7ed;
            color: #c2410c;
        }

        .status-Approved {
            background: #ecfdf5;
            color: #047857;
        }

        .status-New {
            background: #eff6ff;
            color: #1d4ed8;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        .data-table th {
            font-weight: 600;
            color: var(--text-sidebar);
            background: #f8fafc;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }

        /* Login Protection Styles */
        #loginOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0f172a;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 40px 100px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 400px;
            overflow: hidden;
            text-align: center;
        }

        .login-header {
            background: #1e293b;
            padding: 40px 20px;
        }

        .login-body {
            padding: 40px;
        }

        .login-logo {
            width: 150px;
            margin-bottom: 0;
        }

        .login-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: #0f172a;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }

        .login-btn:hover {
            background: #1e293b;
        }

        .error-msg {
            color: #ef4444;
            font-size: 13px;
            margin-bottom: 15px;
            display: none;
        }

        #adminContent {
            display: none;
        }

        /* Detail Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10001;
        }

        .details-modal {
            background: white;
            width: 90%;
            max-width: 600px;
            border-radius: 12px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            animation: modalSlide 0.3s ease-out;
        }

        @keyframes modalSlide {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: #1e293b;
            padding: 20px 30px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 30px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 20px 30px;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        .detail-row {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #f1f5f9;
            padding-bottom: 10px;
        }

        .detail-label {
            width: 150px;
            font-weight: 600;
            color: #64748b;
            font-size: 13px;
            text-transform: uppercase;
        }

        .detail-value {
            flex: 1;
            color: #1e293b;
            font-size: 14px;
        }

        .btn-approve {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-approve:hover {
            background: #059669;
        }

        .close-modal {
            background: transparent;
            border: none;
            color: #94a3b8;
            font-size: 24px;
            cursor: pointer;
        }

        /* Dashboard Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--accent-gold);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 14px;
            color: #64748b;
            font-weight: 500;
        }
    </style>
</head>

<body>
    <!-- Detail Modal -->
    <div id="detailModal" class="modal-overlay">
        <div class="details-modal">
            <div class="modal-header">
                <h3 id="modalTitle">Application Details</h3>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be injected here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal()">Close</button>
                <button id="approveBtn" class="btn-approve" onclick="approveCurrent()">Approve</button>
            </div>
        </div>
    </div>
    <!-- Admin Login Overlay -->
    <div id="loginOverlay">
        <div class="login-card">
            <div class="login-header">
                <img src="../assets/images/Horizon-Tours-Travels-White.svg" class="login-logo" alt="Horizon DMC">
            </div>

            <div class="login-body">
                <h3>Admin Access</h3>
                <p style="color: #64748b; font-size: 14px; margin-bottom: 25px;">Please sign in to continue</p>

                <div id="errorMsg" class="error-msg">Invalid username or password</div>

                <input type="text" id="username" class="login-input" placeholder="Username">
                <input type="password" id="password" class="login-input" placeholder="Password">
                <button class="login-btn" onclick="handleLogin()">Login</button>
            </div>
        </div>
    </div>

    <!-- Main Admin Panel Content -->
    <div id="adminContent" class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <img src="../assets/images/Horizon-Tours-Travels-White.svg" alt="Horizon Admin" class="sidebar-logo">
            </div>
            <nav class="nav-links">
                <a href="#" class="nav-item" onclick="switchTab('dashboard')">
                    Dashboard
                </a>
                <a href="#" class="nav-item" onclick="switchTab('applications')">
                    Partner Applications
                </a>
                <a href="#" class="nav-item" onclick="switchTab('requests')">
                    Agent Inquiries
                </a>
                <a href="#" class="nav-item" onclick="handleLogout()">
                    Logout
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-header">
                <h2 id="pageTitle">Partner Applications</h2>
                <div class="user-profile">
                    <span>Admin User</span>
                    <div class="avatar">A</div>
                </div>
            </header>

            <!-- Dashboard Section -->
            <div id="dashboardSection" class="scrollable-content">
                <div class="stats-grid">
                    <div class="stat-card" style="border-left-color: #3b82f6;">
                        <div class="stat-value" id="statTotalInquiries">0</div>
                        <div class="stat-label">Total Inquiries</div>
                    </div>
                    <div class="stat-card" style="border-left-color: #10b981;">
                        <div class="stat-value" id="statTotalPartners">0</div>
                        <div class="stat-label">Total Partners</div>
                    </div>
                    <div class="stat-card" style="border-left-color: #f59e0b;">
                        <div class="stat-value" id="statPending">0</div>
                        <div class="stat-label">Pending Action</div>
                    </div>
                    <div class="stat-card" style="border-left-color: #8b5cf6;">
                        <div class="stat-value">24h</div>
                        <div class="stat-label">Avg. Response</div>
                    </div>
                </div>

                <div class="card" style="margin-top: 25px;">
                    <h3>Recent Inquiries Preview</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Agency</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="dashboardRecentBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                    <a href="#" onclick="switchTab('requests')"
                        style="display: block; margin-top: 15px; color: #3b82f6; text-decoration: none; font-size: 14px; font-weight: 600;">View
                        All Inquiries â†’</a>
                </div>
            </div>

            <!-- Partner Applications Section -->
            <div id="applicationsSection" class="scrollable-content">
                <div class="card">
                    <h3>Direct Partner Applications</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Ref ID</th>
                                <th>Company</th>
                                <th>Country</th>
                                <th>Contact</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="applicationTableBody">
                            <!-- Rows will be populated here -->
                        </tbody>
                    </table>
                    <div id="emptyState" class="empty-state" style="display: none;">
                        No applications found.
                    </div>
                </div>
            </div>

            <!-- Agent Requests Section -->
            <div id="requestsSection" class="scrollable-content" style="display: none;">
                <div class="card">
                    <h3>B2B Agent Inquiries</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>ID</th>
                                <th>Agency Name</th>
                                <th>Contact Person</th>
                                <th>Country</th>
                                <th>Status</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="requestsTableBody">
                            <!-- Rows will be populated here -->
                        </tbody>
                    </table>
                    <div id="requestsEmptyState" class="empty-state" style="display: none;">
                        No inquiries found.
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Check Session on Load
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('adminAuth') === 'true') {
                showAdminContent();
                switchTab('dashboard');
            }
        });

        // Logout on tab close (as requested: "when i clised the tab... remove creds")
        window.addEventListener('beforeunload', function (e) {
            // Note: This matches the user's request, though it also triggers on refresh.
            // To exclude refresh, one could check performance.navigation.type
            localStorage.removeItem('adminAuth');
        });

        function handleLogin() {
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            const error = document.getElementById('errorMsg');

            // Simple demonstration credentials
            if (user === 'admin' && pass === 'horizon2024') {
                localStorage.setItem('adminAuth', 'true');
                showAdminContent();
                switchTab('dashboard');
            } else {
                error.style.display = 'block';
            }
        }

        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('adminAuth');
                location.reload();
            }
        }

        // Replace this with your actual Google Apps Script Web App URL
        const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbzuosNnc8vrf_CArjgehJmubZ4J0kP5f7FUh3SUGcp-A5-P6ovVHO4fqHd_QFfPIHgd0Q/exec';

        function showAdminContent() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('adminContent').style.display = 'flex';

            // Try to load from backend, fallback to localStorage
            fetch(`${BACKEND_URL}?action=read`)
                .then(res => res.json())
                .then(data => {
                    if (data.agentRequests) {
                        localStorage.setItem('agentRequests', JSON.stringify(data.agentRequests));
                    }
                    if (data.partnerApplications) {
                        localStorage.setItem('partnerApplications', JSON.stringify(data.partnerApplications));
                    }
                    loadApplications();
                    loadRequests();
                })
                .catch(err => {
                    console.error('Failed to fetch from backend, using local data:', err);
                    loadApplications();
                    loadRequests();
                });
        }

        function switchTab(tab) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const title = document.getElementById('pageTitle');

            document.getElementById('dashboardSection').style.display = 'none';
            document.getElementById('applicationsSection').style.display = 'none';
            document.getElementById('requestsSection').style.display = 'none';

            if (tab === 'dashboard') {
                document.querySelectorAll('.nav-item')[0].classList.add('active');
                document.getElementById('dashboardSection').style.display = 'block';
                title.innerText = 'Admin Dashboard';
                updateDashboardStats();
            } else if (tab === 'applications') {
                document.querySelectorAll('.nav-item')[1].classList.add('active');
                document.getElementById('applicationsSection').style.display = 'block';
                title.innerText = 'Partner Applications';
            } else if (tab === 'requests') {
                document.querySelectorAll('.nav-item')[2].classList.add('active');
                document.getElementById('requestsSection').style.display = 'block';
                title.innerText = 'Agent Inquiries';
            }
        }

        function updateDashboardStats() {
            const apps = JSON.parse(localStorage.getItem('partnerApplications') || '[]');
            const reqs = JSON.parse(localStorage.getItem('agentRequests') || '[]');

            const pendingApps = apps.filter(a => a.status === 'Pending').length;
            const pendingReqs = reqs.filter(r => r.status === 'New' || r.status === 'Pending').length;

            document.getElementById('statTotalPartners').innerText = apps.length;
            document.getElementById('statTotalInquiries').innerText = reqs.length;
            document.getElementById('statPending').innerText = pendingApps + pendingReqs;

            // Populate dashboard table preview (top 5)
            const recentBody = document.getElementById('dashboardRecentBody');
            recentBody.innerHTML = '';
            reqs.slice(0, 5).forEach(req => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${req.date}</td>
                    <td>${req.agencyName}</td>
                    <td><span class="status-badge status-${req.status}">${req.status}</span></td>
                `;
                recentBody.appendChild(tr);
            });
        }

        function loadApplications() {
            const tbody = document.getElementById('applicationTableBody');
            tbody.innerHTML = '';
            const emptyState = document.getElementById('emptyState');
            const applications = JSON.parse(localStorage.getItem('partnerApplications') || '[]');

            if (applications.length === 0) {
                emptyState.style.display = 'block';
                return;
            } else {
                emptyState.style.display = 'none';
            }

            applications.forEach(app => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${app.date || '-'}</td>
                    <td>${app.id}</td>
                    <td>${app.companyName}</td>
                    <td>${app.country}</td>
                    <td>${app.contactName}<br><small>${app.email}</small></td>
                    <td><span class="status-badge status-${app.status}">${app.status}</span></td>
                    <td>
                        <button class="btn btn-outline" style="font-size: 12px; padding: 4px 8px;" onclick="viewApp('${app.id}', 'partner')">View</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function loadRequests() {
            const tbody = document.getElementById('requestsTableBody');
            tbody.innerHTML = '';
            const emptyState = document.getElementById('requestsEmptyState');
            const requests = JSON.parse(localStorage.getItem('agentRequests') || '[]');

            if (requests.length === 0) {
                emptyState.style.display = 'block';
                return;
            } else {
                emptyState.style.display = 'none';
            }

            requests.forEach(req => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${req.date}</td>
                    <td>${req.id}</td>
                    <td>${req.agencyName}</td>
                    <td>${req.contactName}</td>
                    <td>${req.country}</td>
                    <td><span class="status-badge status-${req.status}">${req.status}</span></td>
                    <td>
                        <button class="btn btn-outline" style="font-size: 12px; padding: 4px 8px;" onclick="viewApp('${req.id}', 'agent')">View</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        let currentItem = null;
        let currentType = null;

        function viewApp(id, type) {
            const key = type === 'partner' ? 'partnerApplications' : 'agentRequests';
            const data = JSON.parse(localStorage.getItem(key) || '[]');
            const item = data.find(i => i.id === id);

            if (item) {
                currentItem = item;
                currentType = type;

                const modal = document.getElementById('detailModal');
                const modalBody = document.getElementById('modalBody');
                const modalTitle = document.getElementById('modalTitle');
                const approveBtn = document.getElementById('approveBtn');

                modalTitle.innerText = type === 'partner' ? 'Partner Application' : 'Agent Inquiry';

                // Show/Hide approve button based on status
                if (item.status === 'Approved') {
                    approveBtn.style.display = 'none';
                } else {
                    approveBtn.style.display = 'inline-block';
                }

                let html = '';
                Object.keys(item).forEach(key => {
                    if (key !== 'type') {
                        html += `
                            <div class="detail-row">
                                <div class="detail-label">${key.replace(/([A-Z])/g, ' $1')}</div>
                                <div class="detail-value">${item[key]}</div>
                            </div>
                        `;
                    }
                });

                modalBody.innerHTML = html;
                modal.style.display = 'flex';
            }
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        function approveCurrent() {
            if (!currentItem || !currentType) return;

            const key = currentType === 'partner' ? 'partnerApplications' : 'agentRequests';
            let data = JSON.parse(localStorage.getItem(key) || '[]');
            const index = data.findIndex(i => i.id === currentItem.id);

            if (index !== -1) {
                data[index].status = 'Approved';
                localStorage.setItem(key, JSON.stringify(data));

                // Update Google Sheets Status (Background)
                fetch(BACKEND_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                        action: 'updateStatus',
                        id: currentItem.id,
                        status: 'Approved',
                        type: currentType
                    })
                });

                alert('Status updated to Approved');
                closeModal();
                loadApplications();
                loadRequests();
            }
        }
    </script>
</body>

</html>
